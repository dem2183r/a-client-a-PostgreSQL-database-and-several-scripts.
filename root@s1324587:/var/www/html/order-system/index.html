<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Order System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .controls { text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        input, button { padding: 12px; margin: 5px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #stats { margin-top: 30px; padding: 20px; background: #e9ecef; border-radius: 5px; }
        .stat-item { margin: 10px 0; padding: 8px; background: white; border-radius: 3px; }
        .stat-header { font-weight: bold; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 10px; }
        .category-stat { margin-left: 20px; }
        .loading { color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Система заказов</h1>

        <div class="controls">
            <label>Количество повторов:</label>
            <input type="number" id="repeatCount" value="1000" min="1" max="10000">
            <button onclick="startProcess()" id="startBtn">Запустить</button>
            <div id="status"></div>
        </div>

        <div id="stats">
            <div class="stat-header">Статистика в реальном времени:</div>
            <div id="statsContent" class="loading">Загрузка данных...</div>
        </div>
    </div>

    <script>
        let pollingInterval;
        let isRunning = false;

        function startProcess() {
            if (isRunning) return;

            const count = document.getElementById('repeatCount').value;
            const btn = document.getElementById('startBtn');
            const status = document.getElementById('status');

            isRunning = true;
            btn.disabled = true;
            btn.textContent = 'Выполняется...';
            status.innerHTML = '<div style="color: #28a745;">Запуск процесса...</div>';

            // Запуск Beta скрипта
            fetch(`beta.php?n=${count}`)
                .then(response => response.json())
                .then(data => {
                    status.innerHTML = `<div style="color: #28a745;">Процесс запущен: ${data.count} итераций</div>`;
                    setTimeout(() => {
                        isRunning = false;
                        btn.disabled = false;
                        btn.textContent = 'Запустить';
                        status.innerHTML = '<div style="color: #17a2b8;">Процесс завершен</div>';
                    }, 2000);
                })
                .catch(error => {
                    status.innerHTML = `<div style="color: #dc3545;">Ошибка: ${error}</div>`;
                    isRunning = false;
                    btn.disabled = false;
                    btn.textContent = 'Запустить';
                });
        }

        function startPolling() {
            // Очистка предыдущего интервала
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // Опрос каждую секунду
            pollingInterval = setInterval(fetchStats, 1000);
        }

        function fetchStats() {
            fetch('gamma.php')
                .then(response => response.json())
                .then(data => {
                    displayStats(data);
                })
                .catch(error => {
                    document.getElementById('statsContent').innerHTML =
                        `<div class="stat-item" style="color: #dc3545;">Ошибка загрузки: ${error}</div>`;
                });
        }

        function displayStats(data) {
            const container = document.getElementById('statsContent');

            if (data.error) {
                container.innerHTML = `<div class="stat-item" style="color: #dc3545;">Ошибка: ${data.error}</div>`;
                return;
            }

            let html = `
                <div class="stat-item"><strong>Всего заказов:</strong> ${data.total_orders}</div>
                <div class="stat-item"><strong>Период:</strong> ${data.time_period.duration}</div>
                <div class="stat-item"><strong>С первого по последний заказ:</strong></div>
                <div class="stat-item category-stat">Начало: ${new Date(data.time_period.first_order).toLocaleString()}</div>
                <div class="stat-item category-stat">Конец: ${new Date(data.time_period.last_order).toLocaleString()}</div>
                <div class="stat-item"><strong>Статистика по категориям:</strong></div>
            `;

            if (data.category_statistics && data.category_statistics.length > 0) {
                data.category_statistics.forEach(cat => {
                    html += `<div class="stat-item category-stat">
                        <strong>${cat.name}:</strong> ${cat.count} товаров
                    </div>`;
                });
            } else {
                html += `<div class="stat-item category-stat">Нет данных</div>`;
            }

            container.innerHTML = html;
        }

        // Автоматический запуск опроса при загрузке страницы
        window.onload = function() {
            startPolling();
        };
    </script>
</body>
</html>
